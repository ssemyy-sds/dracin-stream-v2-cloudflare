import{p as I,f as m}from"./BxHs40zU.js";import{a as k}from"./Dy99MU8V.js";function l(r,e){let t=r.viewCount||r.playCount||0;if(typeof t=="string"){const s=t.toLowerCase(),o=parseFloat(t);isNaN(o)?t=0:s.includes("k")?t=o*1e3:s.includes("m")?t=o*1e6:t=o}let i={bookId:r.bookId||r.bookid||r.id||"",bookName:r.bookName||r.bookname||r.name||"",cover:m(r.cover||r.coverUrl||r.coverWap||""),introduction:r.introduction||r.description||"",rating:typeof r.rating=="number"?r.rating:I(r.score||r.rating||"0"),genres:Array.isArray(r.genres)?r.genres.map(s=>typeof s=="string"?s:s.name):r.tags||[],status:r.status==="Completed"||r.finished?"Completed":"Ongoing",year:r.year||r.releaseYear||new Date().getFullYear(),latestEpisode:r.latestEpisode||r.latestChapter||r.chapterCount||0,chapterCount:r.chapterCount||r.totalChapter||0,viewCount:t,cornerLabel:r.cornerLabel||r.cornerName||r.status||""};if(e==="api_secondary"){if(r.tags&&Array.isArray(r.tags)){const s=r.tags.map(o=>o.tagName||o.name||o).filter(o=>typeof o=="string");s.length>0&&(i.genres=s)}}else e==="api_backup1"?(r.corner&&r.corner.name&&(i.cornerLabel=r.corner.name),r.introduction&&!i.introduction&&(i.introduction=r.introduction)):e==="api_backup2"&&(r.id&&!i.bookId&&(i.bookId=r.id.toString()),r.name&&!i.bookName&&(i.bookName=r.name),r.cornerName?i.cornerLabel=r.cornerName:r.corner&&typeof r.corner=="string"&&(i.cornerLabel=r.corner));return i}function L(r,e){const t={chapterId:r.chapterId||r.chapterid||r.id||"",chapterIndex:r.chapterIndex||r.index||0,chapterName:r.chapterName||r.name||r.title||`Episode ${r.chapterIndex||0}`,cover:m(r.cover||r.coverUrl||""),videoUrl:"",qualityOptions:[]},i=r.videoUrl||r.url||r.videoPath;return i&&(t.videoUrl=m(i),t.qualityOptions.push({quality:720,videoUrl:t.videoUrl,isDefault:!0})),e==="api_secondary"&&r.cdnList&&Array.isArray(r.cdnList)&&(r.cdnList.forEach(s=>{s.videoPathList&&Array.isArray(s.videoPathList)&&s.videoPathList.forEach(o=>{const n=o.videoPath||o.path||o.url;if(n){const a=o.quality||o.definition||720;t.qualityOptions.push({quality:a,videoUrl:n,isDefault:!1})}})}),t.qualityOptions.length>0&&(t.qualityOptions.sort((s,o)=>o.quality-s.quality),t.videoUrl=t.qualityOptions[0].videoUrl,t.qualityOptions[0].isDefault=!0)),t}const v="/api/proxy";function h(r,e=null){console.log(`[API Service Debug] ${r}`,e?JSON.stringify(e).substring(0,200):"")}function P(r,e){return r==null?{valid:!1,error:"Empty response"}:r.error?{valid:!1,error:typeof r.error=="string"?r.error:JSON.stringify(r.error)}:r.success===!1?{valid:!1,error:r.message||"API returned success: false"}:["home","trending","recommend","foryou","latest","search","vip","allepisode"].includes(e)&&!(Array.isArray(r)||r.data&&Array.isArray(r.data)||r.data&&r.data.list&&Array.isArray(r.data.list)||r.columnVoList||r.bookList)&&Object.keys(r).length===0?{valid:!1,error:`No data returned for ${e}`}:{valid:!0}}function u(r){return r?Array.isArray(r)?r:r.data&&Array.isArray(r.data)?r.data:r.data&&r.data.list&&Array.isArray(r.data.list)?r.data.list:r.bookList&&Array.isArray(r.bookList)?r.bookList:[]:[]}async function A(r,e){const t=await fetch(r),i=t.headers.get("X-Active-Provider")||"unknown";if(k.set(i),h(`Response Status: ${t.status} for ${e} from ${i}`),!t.ok){let n=`HTTP ${t.status}`;try{const a=await t.json();n=a.detail||a.error||n,console.error(`[API Service] Error for ${e}:`,a)}catch{n=(await t.text().catch(()=>"No error text")).substring(0,200)}throw new Error(`API error (${t.status}): ${n}`)}const s=await t.json(),o=P(s,e);return o.valid||console.warn(`[API Service] Validation warning for ${e}: ${o.error}`),h(`Success from ${i} for ${e}`),{data:s,providerId:i}}async function c(r,e={}){const t=new URLSearchParams(e).toString(),i=`${v}/${r}${t?"?"+t:""}`;h(`Fetching: ${i}`,e);try{return await A(i,r)}catch(s){if(console.error(`[API Service] Fetch failed for ${r}:`,s.message),!e.provider){const o="api_backup1";console.warn(`[API] Default provider failed, trying fallback: ${o}`);try{const n={...e,provider:o},a=new URLSearchParams(n).toString(),y=`${v}/${r}${a?"?"+a:""}`;return await A(y,r)}catch(n){console.error(`[API Service] Fallback to ${o} also failed:`,n.message)}}throw s}}async function x(r){var s;let{data:e,providerId:t}=await c("detail",{bookId:r});if(t==="api_secondary"){const o=await c("search",{query:r}),n=((s=o.data)==null?void 0:s.data)||o.data||[];if(Array.isArray(n)&&n.length>0)return l(n[0],t)}const i=(e==null?void 0:e.data)||e;return l(i,t)}async function O(r){const{data:e,providerId:t}=await c("allepisode",{bookId:r}),i=Array.isArray(e)?e:(e==null?void 0:e.data)||[];return Array.isArray(i)?i.map((s,o)=>L(s,t)):(console.warn("[API] getAllEpisodes: No valid episode array found"),[])}async function C(r,e){const{data:t,providerId:i}=await c("allepisode",{bookId:r});if(!Array.isArray(t)||t.length===0)return[];const s=Math.max(0,e-1),o=t[s]||t[0],n=L(o,i);if(n.qualityOptions.length>0)return n.qualityOptions;if(n.chapterId)try{const{data:a}=await c("stream",{bookId:r,chapterId:n.chapterId}),y=[];return a.cdnList&&Array.isArray(a.cdnList)&&a.cdnList.forEach(f=>{f.videoPathList&&Array.isArray(f.videoPathList)&&f.videoPathList.forEach(p=>{const g=p.videoPath||p.path||p.url;if(g){let d=g;f.cdnDomain&&!g.startsWith("http")&&(d=`https://${f.cdnDomain}${g.startsWith("/")?"":"/"}${g}`),y.push({quality:p.quality||p.definition||720,videoUrl:m(d),isDefault:!1})}})}),y.length===0&&(a.videoUrl||a.url)&&y.push({quality:a.quality||720,videoUrl:m(a.videoUrl||a.url),isDefault:!0}),y.sort((f,p)=>p.quality-f.quality)}catch(a){console.error("Failed to fetch secondary stream:",a)}return[]}async function $(r=1,e=20){const{data:t,providerId:i}=await c("home",{page:r.toString(),size:e.toString()});return u(t).map(o=>l(o,i))}async function F(r=1,e=20){try{const{data:t,providerId:i}=await c("recommend",{page:r.toString(),size:e.toString()}),s=u(t);if(s.length>0)return s.map(o=>l(o,i))}catch{}return w()}async function b(){const{data:r,providerId:e}=await c("trending");return u(r).map(i=>l(i,e))}async function D(){const{data:r,providerId:e}=await c("populersearch");return u(r).map(i=>l(i,e))}async function q(){const{data:r,providerId:e}=await c("latest");return u(r).map(i=>l(i,e))}async function w(){try{const{data:r,providerId:e}=await c("recommend",{page:"1",size:"20"}),t=u(r);if(t.length>0)return t.map(i=>l(i,e))}catch{console.warn("[API] Recommend failed, falling back to home")}return $(1,20)}async function S(r=1){const{data:e,providerId:t}=await c("vip",{page:r.toString()});let i=u(e);if(i.length===0){e.columnVoList&&e.columnVoList.forEach(o=>{o.bookInfoList&&i.push(...o.bookInfoList),o.bookList&&i.push(...o.bookList)});const s=e.data||e;s.bookList?i=s.bookList:s.columnVoList&&s.columnVoList.forEach(o=>{o.bookList&&i.push(...o.bookList)})}return i.map(s=>l(s,t))}async function U(r="all",e=1){const{data:t,providerId:i}=await c("dubindo",{classify:r,page:e.toString()});return u(t).map(o=>l(o,i))}async function R(r){const{data:e,providerId:t}=await c("search",{query:r});return u(e).map(s=>l(s,t))}async function V(r,e=1){switch(r){case"trending":return b();case"foryou":return w();case"latest":return q();case"vip":return S(e);case"dubindo":return U("all",e);case"populersearch":return D();default:return b()}}export{x as a,O as b,$ as c,F as d,S as e,C as f,V as g,R as s};
